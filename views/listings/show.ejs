<% layout('layouts/boilerplate') %>

<div class="row mt-4 justify-content-center">
  <div class="col-md-8">

    <!-- Listing Title -->
    <h3 class="mb-4 text-center"><%= listing.title %></h3>

    <!-- Listing Card -->
    <div class="card shadow-sm listing-card">
      <img src="<%= listing.image && listing.image.length > 0 ? listing.image[0].url : '/images/default.jpg' %>" 
           class="card-img-top show-img" 
           alt="listing image" 
           style="height: 400px; object-fit: cover;" />

      <div class="card-body">
        <p class="card-text"><i>Owned by: <%= listing.owner ? listing.owner.username : "avinish" %></i></p>
        <p class="card-text"><%= listing.description %></p>
        <p class="card-text"><strong>Price:</strong> &#8377;<%= listing.price ? listing.price.toLocaleString("en-IN") : "Not available" %></p>
        <p class="card-text"><strong>Country:</strong> <%= listing.country %></p>
        <p class="card-text"><strong>Location:</strong> <%= listing.location %></p>

        <!-- Pay Button for non-owner logged-in users -->
        <% if(currUser && (!listing.owner || currUser._id.toString() !== listing.owner._id.toString())) { %>
          <div class="mt-4 text-center">
            <button id="pay-button" class="btn btn-success btn-lg">Pay Now</button>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Owner Edit/Delete Options -->
    <% if(currUser && listing.owner && currUser._id.toString() === listing.owner._id.toString()){ %>
      <div class="d-flex justify-content-between mt-4">
        <a href="/listings/<%= listing._id %>/edit" class="btn btn-outline-primary">Edit</a>
        <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
          <button type="submit" class="btn btn-outline-danger">Delete</button>
        </form>
      </div>
    <% } %>

    <!-- Review Section -->
    <% if(currUser){ %>
      <hr/>
      <div class="col-md-8">
        <h4>Leave a Review</h4>
        <form action="/listings/<%= listing._id %>/reviews/" method="POST" class="needs-validation" novalidate>
          <label for="rating" class="form-label">Rating</label>
          <fieldset class="starability-slot">
            <input type="radio" id="first-rate1" name="review[rating]" value="1" />
            <label for="first-rate1" title="Terrible">1 star</label>
            <input type="radio" id="first-rate2" name="review[rating]" value="2" />
            <label for="first-rate2" title="Not good">2 stars</label>
            <input type="radio" id="first-rate3" name="review[rating]" value="3" />
            <label for="first-rate3" title="Average">3 stars</label>
            <input type="radio" id="first-rate4" name="review[rating]" value="4" />
            <label for="first-rate4" title="Very good">4 stars</label>
          </fieldset>

          <div class="mt-3 mb-3">
            <label for="comment" class="form-label">Comments</label>
            <textarea name="review[comment]" id="comment" cols="30" rows="5" class="form-control" required></textarea>
            <div class="invalid-feedback">Please add comments for review</div>
          </div>
          <button class="btn btn-dark-outline">Submit</button>
        </form>
      </div>
    <% } %>

    <hr/>

    <!-- Display Reviews -->
    <div class="row">
      <p><b>All Reviews</b></p>
      <% for(let review of listing.reviews) { %>
        <div class="card col-5 ms-3 mb-3">
          <div class="card-body">
            <h5 class="card-title">@<%= review.author.username %></h5>
            <p class="starability-result card-text" data-rating="<%= review.rating %>">Rated: <%= review.rating %> Stars</p>
            <p class="card-text"><%= review.comment %></p>
            <% if(currUser && review.author._id.toString() === currUser._id.toString()) { %>
              <form class="mb-3" method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                <button class="btn btn-sm btn-dark">Delete</button>
              </form>
            <% } %>
          </div>
        </div>
      <% } %>
    </div>

    <!-- Map -->
    <div class="col-md-8 mt-4">
      <h4>Where you will be</h4>
      <div id="map" style="height: 300px;"></div>
    </div>

  </div>
</div>

<!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
const payBtn = document.getElementById("pay-button");

if(payBtn){
  payBtn.addEventListener("click", async (e) => {
    e.preventDefault();

    const listingId = "<%= listing._id %>";

    try {
      // 1️⃣ Create order on server
      const res = await fetch("/payment/create-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ listingId })
      });

      const data = await res.json();
      if(!data.success) throw new Error(data.error || "Failed to create order");

      // 2️⃣ Setup Razorpay options
      const options = {
        key: "<%= RAZORPAY_KEY_ID %>",
        amount: data.order.amount,
        currency: data.order.currency,
        name: "Avinish Private Limited",
        description: "Payment for listing",
        order_id: data.order.id,
        handler: async function(response){
          try {
            const verifyRes = await fetch("/payment/verify", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                razorpay_order_id: response.razorpay_order_id,
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_signature: response.razorpay_signature
              })
            });

            const verifyData = await verifyRes.json();
            if(verifyData.success){
              alert("Payment verified ✅");
            } else {
              alert("Payment verification failed ❌");
              console.error(verifyData.message);
            }
          } catch(err){
            console.error("Verification Error:", err);
            alert("Payment verification failed ❌");
          }
        },
        theme: { color: "#007bff" }
      };

      // 3️⃣ Open Razorpay Checkout
      const rzp1 = new Razorpay(options);
      rzp1.open();

    } catch(err){
      console.error("Payment Error:", err);
      alert("Payment failed! Check console for details.");
    }
  });
}
</script>

<script src="/js/map.js"></script>
